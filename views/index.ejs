<% layout('layouts/boilerplate') -%>

<h1 class="mb-4">Dashboard</h1>

<div class="row g-4">
  <% const cards = [
    { icon: 'fas fa-users', title: 'Owners', description: 'Register new pet owners and access client history and contact information.', link: '/owners', btnText: 'View & Manage Owners' },
    { icon: 'fas fa-dog', title: 'Pets', description: 'Maintain detailed records for all registered pets, including medical history and species.', link: '/pets', btnText: 'View & Manage Pets' },
    { icon: 'fas fa-bed', title: 'Boarding', description: 'Schedule new boarding stays and review past and upcoming reservations.', link: '/boarding/bookings', btnText: 'Manage Bookings' }
  ]; %>

  <% cards.forEach(card => { %>
    <div class="col-md-4">
      <div class="card phms-card-dark shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">
            <i class="<%= card.icon %> me-2" aria-hidden="true"></i><%= card.title %>
          </h5>
          <p class="card-text mb-4"><%= card.description %></p>
          <div class="mt-auto">
            <a href="<%= card.link %>" class="btn btn-outline-golden w-100">
              <%= card.btnText %>
            </a>
          </div>
        </div>
      </div>
    </div>
  <% }) %>
</div>

<!-- Toast Container -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1090;"></div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const toastContainer = document.getElementById("toast-container");
  const socket = io();
  const userId = "<%= user?._id %>";

  // Register socket with backend
  if (userId) {
    socket.emit("registerUser", {
      userId,
      userAgent: navigator.userAgent   // send browser automatically
    });
  }

  // Force logout listener
  socket.on("forceLogout", (msg) => {
    createToast(msg || "You have been logged out.", "danger");
    setTimeout(() => window.location.href = "/login", 1000);
  });

  // Flash messages
  const flashMessages = {
    success: <%- JSON.stringify(success_msg || []) %>,
    error: <%- JSON.stringify(error_msg || []) %>
  };

  flashMessages.success.forEach(msg => createToast(msg, "success"));
  flashMessages.error.forEach(msg => createToast(msg, "danger"));

  function createToast(message, type) {
    const toastEl = document.createElement("div");
    toastEl.className = `toast text-bg-${type} border-0 mb-2`;
    toastEl.role = "alert";
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas ${type === "success" ? "fa-check-circle" : "fa-exclamation-triangle"} me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    toastContainer.appendChild(toastEl);
    new bootstrap.Toast(toastEl, { delay: 3000 }).show();
  }
});
</script>
